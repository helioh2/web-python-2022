{% extends 'base.html' %}

{% block conteudo %}
<h1>{% block title %} Lista de contatos {% endblock %}</h1>


<div class="form-group">
    <label for="busca">Busca:</label>
    <input type="text" class="form-control" id="buscaInput" onkeyup="buscaAjax();">
</div>

<div class="container" id="contatos">
<table class="table table-striped">
    <thead>
    <tr> <th>Nome</th> <th>Telefone</th> <th>Data de Nascimento</th> </tr>
    </thead>

    <tbody>
    {% for contato in contatos %}
        <tr>
            <td>{{contato.nome}}</td>
            <td>{{contato.telefone}}</td>
            <td>{{contato.data_nascimento.strftime("%d/%m/%Y")}}</td>
            <td><a href="{{url_for('remover_contato_action')}}?id={{contato.id}}"><span class="glyphicon glyphicon-trash"></a></td>
            <td><a href="{{url_for('alterar_contato_form')}}?id={{contato.id}}">Alterar</a></td>
        </tr>
    {% endfor %}
    </tbody>
</table>

 <!-- PÁGINAÇÃO -->
 <ul class="pagination">
    {% for i in range(1, total_paginas+1) %}
        <li 
            {% if pagina == i  %} class="active" {% endif %}
            ><a href="{{url_for('contatos')}}?page={{i}}">{{i}}</a></li>
    {% endfor %}
</ul>
</div>

<p><a href="{{ url_for('adicionar_contato_form') }}">Adicionar Contato</a></p>


<script>

    listaOriginal = document.getElementById("contatos").innerHTML;

    function buscaAjax(){
        //document.getElementById("contatos").innerHTML = "BUSCANDO..."
        strBusca = document.getElementById("buscaInput").value

        if (strBusca === "") {
            document.getElementById("contatos").innerHTML = listaOriginal;
            return;
        }
        const timeDelay = 1000;

        // Create an XMLHttpRequest object
        const xhttp = new XMLHttpRequest();

        // Define a callback function
        xhttp.onload = function(){
            if (strBusca === "") {
                document.getElementById("contatos").innerHTML = listaOriginal
                return;
            }
            
            json = JSON.parse(this.responseText);
            console.log(json)
            htmlPart = "<table class='table table-striped'> <thead>  <tr> <th>Nome</th> <th>Telefone</th> <th>Data de Nascimento</th> </tr> </thead> <tbody>";
            json.forEach( function(item, index){
                htmlPart += "<tr>";
                htmlPart += "<td>"+item["nome"]+"</td>";
                htmlPart += "<td>"+item["telefone"]+"</td>";
                htmlPart += "<td>"+item["data_nascimento"]+"</td>";
                htmlPart += "</tr>";
            })
            htmlPart += "</tbody>";
            htmlPart += "</table>";

            document.getElementById("contatos").innerHTML = htmlPart
        }

        sendRequest = function(){
            xhttp.open("GET", "{{url_for('contatos_json')}}?busca="+strBusca);
            xhttp.send();
        }

        sendRequest();

    }
    
</script>

{% endblock %}

